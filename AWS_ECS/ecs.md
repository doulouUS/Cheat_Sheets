# Set up Amazon ECS

Don't directly use your AWS account credentials, instead create an IAM user, add it to a group for which you define permissions.

Then create VPC

then Security group: need external network access, need to be created in each region you want it to be deployed

## Docker for Amazon ECS

* get the CLI
* current user has permissions to use Amazon ECR

### Pushing image to AWS ECR (optional if docker image on Dockerhub already)

You need to push your Docker image to a registry (like Docker hub), called Amazon Elastic Container Registry (charged per amount of data used and transferred to the internet).

Create a repository on AWS ECR.

```bash
aws ecr create-repository --repository-name hello-repository --region region
```

Create a target image (to be exported to Amazon ECR) referencing the existing local image

```bash
docker tag hello-world aws_account_id.dkr.ecr.region.amazonaws.com/hello-repository
```

Login to docker, the following command gives you the command to be run (allows you to connect to a docker registry)

```bash
aws ecr get-login --no-include-email --region region
```

Ex. of output with password generated by AWS and URL to the ECR server (remote AWS registry). This command gives a token access for 12h:

```bash
docker login -u AWS -p LONG_PASSWORD_HERE https://709232555875.dkr.ecr.us-west-1.amazonaws.com
```

Push the image generated previously that was tagged with the repositoryUri

```bash
docker push aws_account_id.dkr.ecr.region.amazonaws.com/hello-repository 
```

Delete the image from the Amazon ECR once done with expermenting as there is a charge:

```bash
aws ecr delete-repository --repository-name hello-repository --region region --force
```

Until now the image is on AWS, ready to be launched as a container. It could have been pushed to Dockerhub more simply.

### Next steps

1. **Create an ECS Cluster**: 
   
   - cluster of EC2 instance with scaling policies (using AutoScaling)
     
      ex. keep 3 instances always running, add an instance if average CPU utilization is 90% for more than 15mn

2. **Create an Elastic Load Balancer**
   
   - Distribute load
   
   - Check Health of instances by pinging

3. **Create IAM Roles**
   
   - Initially EC2 instances are not allowed to communicate to an ECS cluster. Need to create an IAM Role (an identity like a user or a group of users with a set of permissions) and attach it to the EC2 instances.
   
   - Create new Role, and there are predefined set of permissions for this specific case.
   
   - Create also a new role to allow communication between ECS and ELB (when the first is trying to add or diminish the number of containers)

4. **Create an Auto Scaling Group**
   
   - Create Autoscaling group from the EC2 instances UI
   
   - Create launch configuration template describing the EC2 instances to launch (AMI, instance type, security group). In particular, there is an optimized AMI for containerized app available from Amazon Market place.
     
     You actually provide when setting up this autoscaling group, a startup script containing the ECS name to be used.
     
     The cluster should be working now.

5. Run Docker containers in your ECS Cluster
   
   - Create a task
   
   - Run task
     
     - One-off task (run once until completion)
     
     - Services tasks: running continuously

6. Updating Docker containers:
   
   ...
